local Screen= setmetatable({}, {
__index= function(_, key)
local cam= workspace.CurrentCamera
local size= cam and cam.ViewportSize or Vector2.new(1920, 1080)
if key== "Width" then
return size.X
elseif key== "Height" then
return size.Y
elseif key== "Size" then
return size
end end})

local UserInputService = game:GetService("UserInputService")
local Screen = workspace.CurrentCamera.ViewportSize

function scale(axis, value)
    local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled
    local baseWidth, baseHeight = 1920, 1080
    local scaleFactor = isMobile and 2 or 1.5

    if axis == "X" then
        return value * (Screen.X / baseWidth) * scaleFactor
    elseif axis == "Y" then
        return value * (Screen.Y / baseHeight) * scaleFactor
    end
end

function missing(t, f, fallback)
    if type(f) == t then return f end
    return fallback 
end

cloneref = missing("function", cloneref, function(...) return ... end)

local Services = setmetatable({}, {
    __index = function(_, name)
        return cloneref(game:GetService(name))
    end
})

local Players = Services.Players
local RunService = Services.RunService
local UserInputService = Services.UserInputService
local TweenService = Services.TweenService
local AvatarEditorService = Services.AvatarEditorService
local HttpService = Services.HttpService

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local lastPosition = character.PrimaryPart and character.PrimaryPart.Position or Vector3.new()

player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoid = newCharacter:WaitForChild("Humanoid")
    lastPosition = character.PrimaryPart and character.PrimaryPart.Position or Vector3.new()
end)

local Settings = {}
Settings["Stop Emote When Moving"] = true
Settings["Fade In"]     = 0.1
Settings["Fade Out"]    = 0.1
Settings["Weight"]      = 1
Settings["Speed"]       = 1
Settings["Allow Invisible  "]    = true
Settings["Time Position"] = 0
Settings["Freeze On Finish"] = false
Settings["Looped"] = true
Settings["Stop Other Animations On Play"] = true

local savedEmotes = {}
local SAVE_FILE = "GazeEmotes_NewNEWN3WSaved.json"

-- Ê∑ªÂä†Âä®ÁîªÂåÖ‰øùÂ≠òÊñá‰ª∂
local ANIMATION_PACKS_FILE = "GazeEmotes_AnimationPacks.json"
local animationPacks = {}

local function loadSavedEmotes()
    local success, data = pcall(function()
        if readfile and isfile and isfile(SAVE_FILE) then
            return HttpService:JSONDecode(readfile(SAVE_FILE))
        end
        return {}
    end)
    if success and type(data) == "table" then
        savedEmotes = data
    else
        savedEmotes = {}
    end
    for _, v in ipairs(savedEmotes) do
        if not v.AnimationId then
            if v.AssetId then
                v.AnimationId = "rbxassetid://" .. tostring(v.AssetId)
            else
                v.AnimationId = "rbxassetid://" .. tostring(v.Id)
            end
        end
        if v.Favorite == nil then
            v.Favorite = false
        end
    end
end

-- Âä†ËΩΩÂä®ÁîªÂåÖ
local function loadAnimationPacks()
    local success, data = pcall(function()
        if readfile and isfile and isfile(ANIMATION_PACKS_FILE) then
            return HttpService:JSONDecode(readfile(ANIMATION_PACKS_FILE))
        end
        return {}
    end)
    if success and type(data) == "table" then
        animationPacks = data
    else
        animationPacks = {
            {
                Name = "ÈªòËÆ§Âä®ÁîªÂåÖ",
                Id = 1,
                Emotes = {},
                Favorite = false
            }
        }
    end
end

local function saveEmotesToData()
    pcall(function()
        if writefile then
            writefile(SAVE_FILE, HttpService:JSONEncode(savedEmotes))
        end
    end)
end

-- ‰øùÂ≠òÂä®ÁîªÂåÖ
local function saveAnimationPacksToData()
    pcall(function()
        if writefile then
            writefile(ANIMATION_PACKS_FILE, HttpService:JSONEncode(animationPacks))
        end
    end
end

loadSavedEmotes()
loadAnimationPacks()

local CurrentTrack = nil

local function LoadTrack(id)
    if CurrentTrack then 
        CurrentTrack:Stop(Settings["Fade Out"]) 
    end
    local animId
    local ok, result = pcall(function() 
        return game:GetObjects("rbxassetid://" .. tostring(id)) 
    end)
    if ok and result and #result > 0 then
        local anim = result[1]
        if anim:IsA("Animation") then
            animId = anim.AnimationId
        else
            animId = "rbxassetid://" .. tostring(id)
        end
    else
        animId = "rbxassetid://" .. tostring(id)
    end
    local newAnim = Instance.new("Animation")
    newAnim.AnimationId = animId
    local newTrack = humanoid:LoadAnimation(newAnim)
    newTrack.Priority = Enum.AnimationPriority.Action4
    local weight = Settings["Weight"]
    if weight == 0 then weight = 0.001 end
    if Settings["Stop Other Animations On Play"] then
    for _,t in pairs(humanoid.Animator:GetPlayingAnimationTracks())do
        if t.Priority ~= Enum.AnimationPriority.Action4 then
            t:Stop()
        end
    end
    end
    newTrack:Play(Settings["Fade In"], weight, Settings["Speed"])
    CurrentTrack = newTrack 
    CurrentTrack.TimePosition = math.clamp(Settings["Time Position"], 0, 1) * (CurrentTrack.Length or 1)
    CurrentTrack.Priority = Enum.AnimationPriority.Action4
    CurrentTrack.Looped = Settings["Looped"]
    return newTrack
end

RunService.RenderStepped:Connect(function()



if Settings["Looped"] and CurrentTrack and CurrentTrack.IsPlaying then
	CurrentTrack.Looped = Settings["Looped"]
end

if character:FindFirstChild("HumanoidRootPart") then
	local root = character.HumanoidRootPart
	if Settings["Stop Emote When Moving"] and CurrentTrack and CurrentTrack.IsPlaying then
		local moved = (root.Position - lastPosition).Magnitude > 0.1
		local jumped = humanoid and humanoid:GetState() == Enum.HumanoidStateType.Jumping
		if moved or jumped then
			CurrentTrack:Stop(Settings["Fade Out"])
			CurrentTrack = nil
		end
	end

	lastPosition = root.Position
end

end)
local CoreGui = Services.CoreGui
local gui = Instance.new("ScreenGui")
gui.Name = "GazeEmoteGUI"
gui.Parent = CoreGui
gui.Enabled = false
gui.DisplayOrder = 999

local function createGradient(parent, colorSequence) return end

local function createCorner(parent, cornerRadius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, cornerRadius)
    corner.Parent = parent
    return corner
end






local mainContainer = Instance.new("Frame")
mainContainer.Size = UDim2.new(0, scale("X", 600), 0, scale("Y", 400))
mainContainer.Position = UDim2.new(0.5, -scale("X", 400), 0.5, -scale("Y", 250))
mainContainer.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
mainContainer.Active = true
mainContainer.Draggable = true
mainContainer.Parent = gui
createCorner(mainContainer, 12)
local g=Instance.new("UIGradient");g.Color=ColorSequence.new(Color3.fromRGB(255,255,255),Color3.fromRGB(255,255,255));g.Transparency=NumberSequence.new{NumberSequenceKeypoint.new(0,0.05),NumberSequenceKeypoint.new(1,0.1)};g.Parent=mainContainer



local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, scale("Y", 36))
title.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
title.Text = "Gaze Emotes"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.GothamBold
title.TextScaled = true
title.Parent = mainContainer
createCorner(title, 8)

local catalogTabBtn = Instance.new("TextButton")
catalogTabBtn.Size = UDim2.new(0.3, 0, 0, scale("Y", 24))
catalogTabBtn.Position = UDim2.new(0.05, 0, 0, scale("Y", 40))
catalogTabBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 120)
catalogTabBtn.Text = "Catalog"
catalogTabBtn.TextColor3 = Color3.new(1, 1, 1)
catalogTabBtn.Font = Enum.Font.GothamBold
catalogTabBtn.TextScaled = true
catalogTabBtn.Parent = mainContainer
createCorner(catalogTabBtn, 6)

local savedTabBtn = Instance.new("TextButton")
savedTabBtn.Size = UDim2.new(0.3, 0, 0, scale("Y", 24))
savedTabBtn.Position = UDim2.new(0.35, 0, 0, scale("Y", 40))
savedTabBtn.BackgroundColor3 = Color3.fromRGB(60, 120, 60)
savedTabBtn.Text = "Saved"
savedTabBtn.TextColor3 = Color3.new(1, 1, 1)
savedTabBtn.Font = Enum.Font.GothamBold
savedTabBtn.TextScaled = true
savedTabBtn.Parent = mainContainer
createCorner(savedTabBtn, 6)

-- Ê∑ªÂä†Âä®ÁîªÂåÖÊ†áÁ≠æÈ°µÊåâÈíÆ
local animationPacksTabBtn = Instance.new("TextButton")
animationPacksTabBtn.Size = UDim2.new(0.3, 0, 0, scale("Y", 24))
animationPacksTabBtn.Position = UDim2.new(0.65, 0, 0, scale("Y", 40))
animationPacksTabBtn.BackgroundColor3 = Color3.fromRGB(120, 60, 180)
animationPacksTabBtn.Text = "Animation Packs"
animationPacksTabBtn.TextColor3 = Color3.new(1, 1, 1)
animationPacksTabBtn.Font = Enum.Font.GothamBold
animationPacksTabBtn.TextScaled = true
animationPacksTabBtn.Parent = mainContainer
createCorner(animationPacksTabBtn, 6)

local divider = Instance.new("Frame")
divider.Size = UDim2.new(0, scale("X", 2), 1, -scale("Y", 70))
divider.Position = UDim2.new(0.6, -scale("X", 1), 0, scale("Y", 70))
divider.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
divider.Parent = mainContainer
createCorner(divider, 1)

local catalogFrame = Instance.new("Frame")
catalogFrame.Size = UDim2.new(0.6, -scale("X", 10), 1, -scale("Y", 70))
catalogFrame.Position = UDim2.new(0, scale("X", 5), 0, scale("Y", 70))
catalogFrame.BackgroundTransparency = 1
catalogFrame.Visible = true
catalogFrame.Parent = mainContainer

local searchBox = Instance.new("TextBox")
searchBox.Size = UDim2.new(0.6, -scale("X", 8), 0, scale("Y", 28))
searchBox.Position = UDim2.new(0, scale("X", 8), 0, 0)
searchBox.PlaceholderText = "Search..."
searchBox.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
searchBox.TextColor3 = Color3.new(1, 1, 1)
searchBox.Font = Enum.Font.Gotham
searchBox.TextScaled = true
searchBox.ClearTextOnFocus = false
searchBox.Text = ""
searchBox.Parent = catalogFrame
createCorner(searchBox, 6)

local refreshBtn = Instance.new("TextButton")
refreshBtn.Size = UDim2.new(0.2, -scale("X", 4), 0, scale("Y", 28))
refreshBtn.Position = UDim2.new(0.6, scale("X", 4), 0, 0)
refreshBtn.BackgroundColor3 = Color3.fromRGB(0, 100, 220)
refreshBtn.Text = "Refresh"
refreshBtn.Font = Enum.Font.GothamBold
refreshBtn.TextScaled = true
refreshBtn.TextColor3 = Color3.new(1, 1, 1)
refreshBtn.Parent = catalogFrame
createCorner(refreshBtn, 6)

local sortBtn = Instance.new("TextButton")
sortBtn.Size = UDim2.new(0.2, -scale("X", 8), 0, scale("Y", 28))
sortBtn.Position = UDim2.new(0.8, scale("X", 4), 0, 0)
sortBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 120)
sortBtn.Text = "Sort: Relevance"
sortBtn.Font = Enum.Font.GothamBold
sortBtn.TextScaled = true
sortBtn.TextColor3 = Color3.new(1, 1, 1)
sortBtn.Parent = catalogFrame
createCorner(sortBtn, 6)

local savedFrame = Instance.new("Frame")
savedFrame.Size = UDim2.new(0.6, -scale("X", 10), 1, -scale("Y", 70))
savedFrame.Position = UDim2.new(0, scale("X", 5), 0, scale("Y", 70))
savedFrame.BackgroundTransparency = 1
savedFrame.Visible = false
savedFrame.Parent = mainContainer

local savedSearch = Instance.new("TextBox")
savedSearch.Size = UDim2.new(1, -scale("X", 16), 0, scale("Y", 28))
savedSearch.Position = UDim2.new(0, scale("X", 8), 0, 0)
savedSearch.PlaceholderText = "Search Saved..."
savedSearch.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
savedSearch.TextColor3 = Color3.new(1, 1, 1)
savedSearch.Font = Enum.Font.Gotham
savedSearch.TextScaled = true
savedSearch.ClearTextOnFocus = false
savedSearch.Text = ""
savedSearch.Parent = savedFrame
createCorner(savedSearch, 6)

local savedScroll = Instance.new("ScrollingFrame")
savedScroll.Size = UDim2.new(1, -scale("X", 16), 1, -scale("Y", 40))
savedScroll.Position = UDim2.new(0, scale("X", 8), 0, scale("Y", 36))
savedScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
savedScroll.ScrollBarThickness = 0
savedScroll.BackgroundTransparency = 1
savedScroll.Parent = savedFrame

local savedEmptyLabel = Instance.new("TextLabel")
savedEmptyLabel.Size = UDim2.new(1, 0, 0, scale("Y", 36))
savedEmptyLabel.Position = UDim2.new(0, 0, 0.5, -scale("Y", 18))
savedEmptyLabel.BackgroundTransparency = 1
savedEmptyLabel.Text = "Sorry I Was Changing Save Files Again üòÖ"
savedEmptyLabel.TextColor3 = Color3.new(1, 1, 1)
savedEmptyLabel.Font = Enum.Font.GothamBold
savedEmptyLabel.TextScaled = true
savedEmptyLabel.Visible = false
savedEmptyLabel.Parent = savedScroll

local savedLayout = Instance.new("UIGridLayout")
savedLayout.CellSize = UDim2.new(0, scale("X", 120), 0, scale("Y", 200))
savedLayout.CellPadding = UDim2.new(0, scale("X", 8), 0, scale("Y", 8))
savedLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
savedLayout.Parent = savedScroll

-- Ê∑ªÂä†Âä®ÁîªÂåÖÊ°ÜÊû∂
local animationPacksFrame = Instance.new("Frame")
animationPacksFrame.Size = UDim2.new(0.6, -scale("X", 10), 1, -scale("Y", 70))
animationPacksFrame.Position = UDim2.new(0, scale("X", 5), 0, scale("Y", 70))
animationPacksFrame.BackgroundTransparency = 1
animationPacksFrame.Visible = false
animationPacksFrame.Parent = mainContainer

local animationPacksSearch = Instance.new("TextBox")
animationPacksSearch.Size = UDim2.new(1, -scale("X", 16), 0, scale("Y", 28))
animationPacksSearch.Position = UDim2.new(0, scale("X", 8), 0, 0)
animationPacksSearch.PlaceholderText = "Search Animation Packs..."
animationPacksSearch.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
animationPacksSearch.TextColor3 = Color3.new(1, 1, 1)
animationPacksSearch.Font = Enum.Font.Gotham
animationPacksSearch.TextScaled = true
animationPacksSearch.ClearTextOnFocus = false
animationPacksSearch.Text = ""
animationPacksSearch.Parent = animationPacksFrame
createCorner(animationPacksSearch, 6)

local animationPacksScroll = Instance.new("ScrollingFrame")
animationPacksScroll.Size = UDim2.new(1, -scale("X", 16), 1, -scale("Y", 40))
animationPacksScroll.Position = UDim2.new(0, scale("X", 8), 0, scale("Y", 36))
animationPacksScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
animationPacksScroll.ScrollBarThickness = 6
animationPacksScroll.BackgroundTransparency = 1
animationPacksScroll.Parent = animationPacksFrame

local animationPacksEmptyLabel = Instance.new("TextLabel")
animationPacksEmptyLabel.Size = UDim2.new(1, 0, 0, scale("Y", 36))
animationPacksEmptyLabel.Position = UDim2.new(0, 0, 0.5, -scale("Y", 18))
animationPacksEmptyLabel.BackgroundTransparency = 1
animationPacksEmptyLabel.Text = "No Animation Packs Found"
animationPacksEmptyLabel.TextColor3 = Color3.new(1, 1, 1)
animationPacksEmptyLabel.Font = Enum.Font.GothamBold
animationPacksEmptyLabel.TextScaled = true
animationPacksEmptyLabel.Visible = false
animationPacksEmptyLabel.Parent = animationPacksScroll

local animationPacksLayout = Instance.new("UIGridLayout")
animationPacksLayout.CellSize = UDim2.new(0, scale("X", 140), 0, scale("Y", 180))
animationPacksLayout.CellPadding = UDim2.new(0, scale("X", 8), 0, scale("Y", 8))
animationPacksLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
animationPacksLayout.Parent = animationPacksScroll

local settingsFrame = Instance.new("Frame")
settingsFrame.Size = UDim2.new(0.4, -scale("X", 10), 1, -scale("Y", 70))
settingsFrame.Position = UDim2.new(0.6, scale("X", 5), 0, scale("Y", 70))
settingsFrame.BackgroundTransparency = 1
settingsFrame.Parent = mainContainer

local settingsTitle = Instance.new("TextLabel")
settingsTitle.Size = UDim2.new(1, 0, 0, scale("Y", 28))
settingsTitle.BackgroundTransparency = 1
settingsTitle.Text = "Settings"
settingsTitle.TextColor3 = Color3.new(1, 1, 1)
settingsTitle.Font = Enum.Font.GothamBold
settingsTitle.TextScaled = true
settingsTitle.Parent = settingsFrame

local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, -scale("X", 20), 1, -scale("Y", 40))
scrollFrame.Position = UDim2.new(0, scale("X", 10), 0, scale("Y", 30))
scrollFrame.BackgroundTransparency = 1
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = settingsFrame

local function lockX()
    scrollFrame.CanvasPosition = Vector2.new(0, scrollFrame.CanvasPosition.Y)
end
scrollFrame:GetPropertyChangedSignal("CanvasPosition"):Connect(lockX)

local listLayout = Instance.new("UIListLayout", scrollFrame)
listLayout.Padding = UDim.new(0, 6)
listLayout.FillDirection = Enum.FillDirection.Vertical
listLayout.SortOrder = Enum.SortOrder.LayoutOrder

listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 10)
end)

-- Á¨¨‰∏ÄÈÉ®ÂàÜÁªìÊùü
-- ËØ∑ÁªßÁª≠Êü•ÁúãÁ¨¨‰∫åÈÉ®ÂàÜ
-- Á¨¨‰∫åÈÉ®ÂàÜÔºöËÆæÁΩÆÁïåÈù¢ÂíåÂä®ÁîªÂåÖÂäüËÉΩ

 function GetReal(id)
    local ok, obj = pcall(function()
        return game:GetObjects("rbxassetid://"..tostring(id))
    end)
    if ok and obj and #obj > 0 then
        local anim = obj[1]
        if anim:IsA("Animation") and anim.AnimationId ~= "" then
            return tonumber(anim.AnimationId:match("%d+"))
        end
    end
end

Settings._sliders = {}
Settings._toggles = {}

--// ÊªëÂùóÂàõÂª∫Âô®
local function createSlider(name, min, max, default)
    Settings[name] = default or min

    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, 0, 0, scale("Y", 65))
    container.BackgroundTransparency = 1
    container.Parent = scrollFrame

    local bg = Instance.new("Frame")
    bg.Size = UDim2.new(1, 0, 1, 0)
    bg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    bg.Parent = container
    Instance.new("UICorner", bg).CornerRadius = UDim.new(0, 8)

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.5, -scale("X", 10), 0, scale("Y", 20))
    label.Position = UDim2.new(0, 10, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = string.format("%s: %.2f", name, Settings[name])
    label.TextColor3 = Color3.new(1, 1, 1)
    label.Font = Enum.Font.Gotham
    label.TextScaled = true
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = bg

    local textBox = Instance.new("TextBox")
    textBox.Size = UDim2.new(0.5, -scale("X", 20), 0, scale("Y", 20))
    textBox.Position = UDim2.new(0.5, scale("X", 10), 0, scale("Y", 5))
    textBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    textBox.Text = tostring(Settings[name])
    textBox.TextColor3 = Color3.new(1, 1, 1)
    textBox.Font = Enum.Font.Gotham
    textBox.TextScaled = true
    textBox.ClearTextOnFocus = false
    textBox.Parent = bg
    Instance.new("UICorner", textBox).CornerRadius = UDim.new(0, 6)

    local sliderBar = Instance.new("Frame")
    sliderBar.Size = UDim2.new(1, -scale("X", 40), 0, scale("Y", 12))
    sliderBar.Position = UDim2.new(0, scale("X", 20), 0, scale("Y", 35))
    sliderBar.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    sliderBar.Parent = bg
    Instance.new("UICorner", sliderBar).CornerRadius = UDim.new(0, 6)

    local sliderFill = Instance.new("Frame")
    sliderFill.Size = UDim2.new(0, 0, 1, 0)
    sliderFill.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
    sliderFill.Parent = sliderBar
    Instance.new("UICorner", sliderFill).CornerRadius = UDim.new(0, 6)

    local thumb = Instance.new("Frame")
    thumb.Size = UDim2.new(0, scale("X", 20), 0, scale("Y", 20))
    thumb.AnchorPoint = Vector2.new(0.5, 0.5)
    thumb.Position = UDim2.new(0, 0, 0.5, 0)
    thumb.BackgroundColor3 = Color3.fromRGB(230, 230, 230)
    thumb.Parent = sliderBar
    Instance.new("UICorner", thumb).CornerRadius = UDim.new(1, 0)

    local function tweenVisual(rel)
        local visualRel = math.clamp(rel, 0, 1)
        TweenService:Create(sliderFill, TweenInfo.new(0.15), {Size = UDim2.new(visualRel, 0, 1, 0)}):Play()
        TweenService:Create(thumb, TweenInfo.new(0.15), {Position = UDim2.new(visualRel, 0, 0.5, 0)}):Play()
    end

    local function applyValue(value)
        Settings[name] = math.clamp(value, min, max)
        label.Text = string.format("%s: %.2f", name, Settings[name])
        textBox.Text = tostring(Settings[name])
        local rel = (Settings[name] - min) / (max - min)
        tweenVisual(rel)

        if CurrentTrack and CurrentTrack.IsPlaying then
            if name == "Speed" then
                CurrentTrack:AdjustSpeed(Settings["Speed"])
            elseif name == "Weight" then
                local weight = Settings["Weight"]
                if weight == 0 then weight = 0.001 end
                CurrentTrack:AdjustWeight(weight)
            elseif name == "Time Position" then
                if CurrentTrack.Length > 0 then
                    CurrentTrack.TimePosition = math.clamp(value, 0, 1) * CurrentTrack.Length
                end
            end
        end
    end

    local dragging = false
    local function updateFromInput(input)
        local relX = math.clamp((input.Position.X - sliderBar.AbsolutePosition.X) / sliderBar.AbsoluteSize.X, 0, 1)
        local value = math.floor((min + (max - min) * relX) * 100) / 100
        applyValue(value)
    end

    sliderBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            updateFromInput(input)
        end
    end)

    thumb.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            updateFromInput(input)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            updateFromInput(input)
        end
    end)

    UserInputService.InputEnded:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
            dragging = false
        end
    end)

    textBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            local num = tonumber(textBox.Text)
            if num then
                applyValue(num)
            else
                textBox.Text = tostring(Settings[name])
            end
        end
    end)

    Settings._sliders[name] = applyValue
    applyValue(Settings[name])
end

--// ÂºÄÂÖ≥ÂàõÂª∫Âô®
local function createToggle(name)
    Settings[name] = Settings[name] or false

    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, 0, 0, scale("Y", 40))
    container.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    container.Parent = scrollFrame
    Instance.new("UICorner", container).CornerRadius = UDim.new(0, 6)

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.7, -scale("X", 10), 1, 0)
    label.Position = UDim2.new(0, scale("X", 10), 0, 0)
    label.BackgroundTransparency = 1
    label.Text = name
    label.TextColor3 = Color3.new(1, 1, 1)
    label.Font = Enum.Font.Gotham
    label.TextScaled = true
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = container

    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Size = UDim2.new(0, scale("X", 60), 0, scale("Y", 24))
    toggleBtn.Position = UDim2.new(1, -scale("X", 70), 0.5, -scale("Y", 12))
    toggleBtn.TextColor3 = Color3.new(1, 1, 1)
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.TextScaled = true
    toggleBtn.Parent = container
    Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(1, 0)

    local function applyVisual(state)
        toggleBtn.Text = state and "ON" or "OFF"
        toggleBtn.BackgroundColor3 = state and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 0, 0)
    end

    toggleBtn.MouseButton1Click:Connect(function()
        Settings[name] = not Settings[name]
        applyVisual(Settings[name])
    end)

    applyVisual(Settings[name])
    Settings._toggles[name] = applyVisual
end

--// Áªü‰∏ÄÁöÑÁºñËæëÂáΩÊï∞
function Settings:EditSlider(targetName, newValue)
    local apply = self._sliders[targetName]
    if apply then
        apply(newValue)
    end
end

function Settings:EditToggle(targetName, newValue)
    local apply = self._toggles[targetName]
    if apply then
        Settings[targetName] = newValue
        apply(newValue)
    end
end

local function createButton(name, callback)
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, 0, 0, scale("Y", 45))
    container.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    container.Parent = scrollFrame
    Instance.new("UICorner", container).CornerRadius = UDim.new(0, 6)

    local button = Instance.new("TextButton")
    button.Size = UDim2.new(1, -scale("X", 20), 1, -scale("Y", 10))
    button.Position = UDim2.new(0, scale("X", 10), 0, scale("Y", 5))
    button.BackgroundColor3 = Color3.fromRGB(0, 120, 250)
    button.Text = name
    button.TextColor3 = Color3.new(1, 1, 1)
    button.Font = Enum.Font.GothamBold
    button.TextScaled = true
    button.Parent = container
    Instance.new("UICorner", button).CornerRadius = UDim.new(0, 8)

    button.MouseButton1Click:Connect(function()
        if typeof(callback) == "function" then
            callback()
        end
    end)

    return button
end

local resetButton = createButton("Reset Settings", function() end)
createToggle("Stop Emote When Moving")
createToggle("Looped")
createSlider("Speed", 0, 5, Settings["Speed"])
createSlider("Time Position", 0, 1, Settings["Time Position"])
createSlider("Weight", 0, 1, Settings["Weight"])
createSlider("Fade In", 0, 2, Settings["Fade In"])
createSlider("Fade Out", 0, 2, Settings["Fade Out"])
createToggle("Allow Invisible   ")
createToggle("Stop Other Animations On Play")

resetButton.MouseButton1Click:Connect(function()
    Settings:EditToggle("Stop Emote When Moving", true)
    Settings:EditToggle("Stop Other Animations On Play", true)
    Settings:EditSlider("Fade In", 0.1)
    Settings:EditSlider("Fade Out", 0.1)
    Settings:EditSlider("Weight", 1)
    Settings:EditSlider("Speed", 1)
    Settings:EditToggle("Allow Invisible  ", true)
    Settings:EditSlider("Time Position", 0)
    Settings:EditToggle("Freeze On Finish", false)
    Settings:EditToggle("Looped", true)
end)

local originalCollisionStates = {}
local lastFixClipState = Settings["Allow Invisible  "]

local function saveCollisionStates()
    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA("BasePart") and part ~= character.PrimaryPart then
            originalCollisionStates[part] = part.CanCollide
        end
    end
end

local function disableCollisionsExceptRootPart()
    if not Settings["Allow Invisible  "] then
        return
    end
    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA("BasePart") and part ~= character.PrimaryPart then
            part.CanCollide = false
        end
    end
end

local function restoreCollisionStates()
    for part, canCollide in pairs(originalCollisionStates) do
        if part and part.Parent then
            part.CanCollide = canCollide
        end
    end
    originalCollisionStates = {}
end

saveCollisionStates()

local connection
connection = RunService.Stepped:Connect(function()
    if character and character.Parent then
        local currentFixClip = Settings["Allow Invisible  "]
        if lastFixClipState ~= currentFixClip then
            if currentFixClip then
                saveCollisionStates()
                disableCollisionsExceptRootPart()
            else
                restoreCollisionStates()
            end
            lastFixClipState = currentFixClip
        elseif currentFixClip then
            disableCollisionsExceptRootPart()
        end
    else
        restoreCollisionStates()
        if connection then
            connection:Disconnect()
        end
    end
end)

player.CharacterAdded:Connect(function(newCharacter)
    restoreCollisionStates()
    character = newCharacter
    humanoid = newCharacter:WaitForChild("Humanoid")
    saveCollisionStates()
    lastFixClipState = Settings["Allow Invisible  "]
    if connection then
        connection:Disconnect()
    end
    connection = RunService.Stepped:Connect(function()
        if character and character.Parent then
            local currentFixClip = Settings["Allow Invisible  "]
            if lastFixClipState ~= currentFixClip then
                if currentFixClip then
                    saveCollisionStates()
                    disableCollisionsExceptRootPart()
                else
                    restoreCollisionStates()
                end
                lastFixClipState = currentFixClip
            elseif currentFixClip then
                disableCollisionsExceptRootPart()
            end
        else
            restoreCollisionStates()
            if connection then
                connection:Disconnect()
            end
        end
    end)
end)

-- Âä®ÁîªÂåÖÂäüËÉΩÂÆûÁé∞
local function createAnimationPackCard(packData)
    local card = Instance.new("Frame")
    card.Size = UDim2.new(0, scale("X", 140), 0, scale("Y", 180))
    card.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
    createCorner(card, 8)
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, -scale("X", 10), 0, scale("Y", 40))
    nameLabel.Position = UDim2.new(0, scale("X", 5), 0, scale("Y", 5))
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = packData.Name or "Êú™ÂëΩÂêçÂåÖ"
    nameLabel.TextColor3 = Color3.new(1, 1, 1)
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextScaled = true
    nameLabel.TextWrapped = true
    nameLabel.Parent = card
    
    local countLabel = Instance.new("TextLabel")
    countLabel.Size = UDim2.new(1, -scale("X", 10), 0, scale("Y", 20))
    countLabel.Position = UDim2.new(0, scale("X", 5), 0, scale("Y", 50))
    countLabel.BackgroundTransparency = 1
    countLabel.Text = "ÂåÖÂê´ " .. tostring(#packData.Emotes) .. " ‰∏™Ë°®ÊÉÖ"
    countLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    countLabel.Font = Enum.Font.Gotham
    countLabel.TextScaled = true
    countLabel.Parent = card
    
    local viewBtn = Instance.new("TextButton")
    viewBtn.Size = UDim2.new(0.9, 0, 0, scale("Y", 24))
    viewBtn.Position = UDim2.new(0.05, 0, 1, -scale("Y", 55))
    viewBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
    viewBtn.Text = "Êü•Áúã"
    viewBtn.TextColor3 = Color3.new(1, 1, 1)
    viewBtn.Font = Enum.Font.GothamBold
    viewBtn.TextScaled = true
    viewBtn.Parent = card
    createCorner(viewBtn, 6)
    
    local deleteBtn = Instance.new("TextButton")
    deleteBtn.Size = UDim2.new(0.9, 0, 0, scale("Y", 24))
    deleteBtn.Position = UDim2.new(0.05, 0, 1, -scale("Y", 25))
    deleteBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    deleteBtn.Text = "Âà†Èô§"
    deleteBtn.TextColor3 = Color3.new(1, 1, 1)
    deleteBtn.Font = Enum.Font.GothamBold
    deleteBtn.TextScaled = true
    deleteBtn.Parent = card
    createCorner(deleteBtn, 6)
    
    viewBtn.MouseButton1Click:Connect(function()
        showAnimationPackDetails(packData)
    end)
    
    deleteBtn.MouseButton1Click:Connect(function()
        for i, pack in ipairs(animationPacks) do
            if pack.Id == packData.Id then
                table.remove(animationPacks, i)
                saveAnimationPacksToData()
                refreshAnimationPacksTab()
                break
            end
        end
    end)
    
    return card
end

local function showAnimationPackDetails(packData)
    local detailsFrame = Instance.new("Frame")
    detailsFrame.Size = UDim2.new(0, scale("X", 400), 0, scale("Y", 300))
    detailsFrame.Position = UDim2.new(0.5, -scale("X", 200), 0.5, -scale("Y", 150))
    detailsFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    detailsFrame.ZIndex = 10
    detailsFrame.Parent = gui
    createCorner(detailsFrame, 12)
    
    detailsFrame.Active = true
    detailsFrame.Draggable = true
    
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, scale("X", 30), 0, scale("Y", 30))
    closeBtn.Position = UDim2.new(1, -scale("X", 35), 0, scale("Y", 5))
    closeBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextScaled = true
    closeBtn.ZIndex = 11
    closeBtn.Parent = detailsFrame
    createCorner(closeBtn, 15)
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -scale("X", 40), 0, scale("Y", 40))
    titleLabel.Position = UDim2.new(0, scale("X", 10), 0, scale("Y", 10))
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = packData.Name
    titleLabel.TextColor3 = Color3.new(1, 1, 1)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextScaled = true
    titleLabel.ZIndex = 11
    titleLabel.Parent = detailsFrame
    
    local scroll = Instance.new("ScrollingFrame")
    scroll.Size = UDim2.new(1, -scale("X", 20), 1, -scale("Y", 60))
    scroll.Position = UDim2.new(0, scale("X", 10), 0, scale("Y", 60))
    scroll.BackgroundTransparency = 1
    scroll.ScrollBarThickness = 6
    scroll.ZIndex = 11
    scroll.Parent = detailsFrame
    
    local layout = Instance.new("UIListLayout")
    layout.Padding = UDim.new(0, 5)
    layout.Parent = scroll
    
    for _, emote in ipairs(packData.Emotes) do
        local emoteFrame = Instance.new("Frame")
        emoteFrame.Size = UDim2.new(1, 0, 0, scale("Y", 40))
        emoteFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        emoteFrame.ZIndex = 12
        emoteFrame.Parent = scroll
        createCorner(emoteFrame, 6)
        
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Size = UDim2.new(0.6, 0, 1, 0)
        nameLabel.Position = UDim2.new(0, scale("X", 10), 0, 0)
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = emote.Name or "Êú™Áü•Ë°®ÊÉÖ"
        nameLabel.TextColor3 = Color3.new(1, 1, 1)
        nameLabel.Font = Enum.Font.Gotham
        nameLabel.TextScaled = true
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.ZIndex = 13
        nameLabel.Parent = emoteFrame
        
        local playBtn = Instance.new("TextButton")
        playBtn.Size = UDim2.new(0.2, 0, 0.7, 0)
        playBtn.Position = UDim2.new(0.6, scale("X", 5), 0.15, 0)
        playBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 50)
        playBtn.Text = "Êí≠Êîæ"
        playBtn.TextColor3 = Color3.new(1, 1, 1)
        playBtn.Font = Enum.Font.GothamBold
        playBtn.TextScaled = true
        playBtn.ZIndex = 13
        playBtn.Parent = emoteFrame
        createCorner(playBtn, 6)
        
        local removeBtn = Instance.new("TextButton")
        removeBtn.Size = UDim2.new(0.2, 0, 0.7, 0)
        removeBtn.Position = UDim2.new(0.8, scale("X", 5), 0.15, 0)
        removeBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
        removeBtn.Text = "ÁßªÈô§"
        removeBtn.TextColor3 = Color3.new(1, 1, 1)
        removeBtn.Font = Enum.Font.GothamBold
        removeBtn.TextScaled = true
        removeBtn.ZIndex = 13
        removeBtn.Parent = emoteFrame
        createCorner(removeBtn, 6)
        
        playBtn.MouseButton1Click:Connect(function()
            LoadTrack(emote.Id)
        end)
        
        removeBtn.MouseButton1Click:Connect(function()
            for i, e in ipairs(packData.Emotes) do
                if e.Id == emote.Id then
                    table.remove(packData.Emotes, i)
                    saveAnimationPacksToData()
                    showAnimationPackDetails(packData)
                    break
                end
            end
        end)
    end
    
    scroll.CanvasSize = UDim2.new(0, 0, 0, #packData.Emotes * 45)
    
    closeBtn.MouseButton1Click:Connect(function()
        detailsFrame:Destroy()
    end)
end

local function refreshAnimationPacksTab()
    for _, child in ipairs(animationPacksScroll:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end
    
    local text = (animationPacksSearch.Text or ""):lower()
    local results = {}
    
    for _, pack in ipairs(animationPacks) do
        if text == "" or (pack.Name and pack.Name:lower():find(text)) then
            table.insert(results, pack)
        end
    end
    
    if #results > 0 then
        animationPacksEmptyLabel.Visible = false
        for _, pack in ipairs(results) do
            createAnimationPackCard(pack).Parent = animationPacksScroll
        end
    else
        animationPacksEmptyLabel.Visible = true
    end
    
    animationPacksScroll.CanvasSize = UDim2.new(0, 0, 0, animationPacksLayout.AbsoluteContentSize.Y + 10)
end

-- Á¨¨‰∫åÈÉ®ÂàÜÁªìÊùü
-- ËØ∑ÁªßÁª≠Êü•ÁúãÁ¨¨‰∏âÈÉ®ÂàÜ
-- Á¨¨‰∏âÈÉ®ÂàÜÔºöË°®ÊÉÖÁõÆÂΩï„ÄÅÊêúÁ¥¢ÂíåÂä®ÁîªÂåÖÂäüËÉΩ

local sortModes = {
    {Enum.CatalogSortType.Relevance, "Relevance"},
    {Enum.CatalogSortType.PriceHighToLow, "Price High‚ÜíLow"},
    {Enum.CatalogSortType.PriceLowToHigh, "Price Low‚ÜíHigh"},
    {Enum.CatalogSortType.MostFavorited, "Most Favorited"},
    {Enum.CatalogSortType.RecentlyCreated, "Recently Created"},
    {Enum.CatalogSortType.Bestselling, "Bestselling"},
}
local currentSortIndex = 1
local currentKeyword = ""
local currentPages = nil
local currentPageNumber = 1

local function getPages(keyword)
    local params = CatalogSearchParams.new()
    params.SearchKeyword = keyword or ""
    params.CategoryFilter = Enum.CatalogCategoryFilter.None
    params.SalesTypeFilter = Enum.SalesTypeFilter.All
    params.AssetTypes = { Enum.AvatarAssetType.EmoteAnimation }
    params.IncludeOffSale = true
    params.SortType = sortModes[currentSortIndex][1]
    params.Limit = 10
    local ok, pages = pcall(function()
        return AvatarEditorService:SearchCatalog(params)
    end)
    if not ok then
        return nil
    end
    return pages
end

local function createCard(item)
    local card = Instance.new("Frame")
    card.Size = UDim2.new(0, scale("X", 120), 0, scale("Y", 180))
    card.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
    createCorner(card, 8)
    local thumbId = item.AssetId or item.Id
    local img = Instance.new("ImageLabel")
    img.Size = UDim2.new(1, -scale("X", 10), 0, scale("Y", 90))
    img.Position = UDim2.new(0, scale("X", 5), 0, scale("Y", 5))
    img.BackgroundTransparency = 1
    img.ScaleType = Enum.ScaleType.Fit
    pcall(function()
        img.Image = "rbxthumb://type=Asset&id=" .. tonumber(thumbId) .. "&w=150&h=150"
    end)
    img.Parent = card
    createCorner(img, 6)
    local name = Instance.new("TextLabel")
    name.Size = UDim2.new(1, -scale("X", 10), 0, scale("Y", 28))
    name.Position = UDim2.new(0, scale("X", 5), 0, scale("Y", 100))
    name.BackgroundTransparency = 1
    name.Text = item.Name or "Unknown"
    name.TextScaled = true
    name.TextWrapped = true
    name.Font = Enum.Font.GothamBold
    name.TextColor3 = Color3.new(1, 1, 1)
    name.Parent = card
    
    local url = "https://www.roblox.com/catalog/" .. tonumber(item.Id)
    local copyLinkButton = Instance.new("TextButton")
    copyLinkButton.Parent = card
    copyLinkButton.Size = UDim2.new(0, scale("X", 36), 0, scale("Y", 36))
    copyLinkButton.Position = UDim2.new(1, -scale("X", 42), 0, scale("Y", 5))
    copyLinkButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    copyLinkButton.Text = "üõíüîó"
    copyLinkButton.Font = Enum.Font.GothamBold
    copyLinkButton.TextScaled = true
    copyLinkButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    copyLinkButton.AutoButtonColor = false
    createCorner(copyLinkButton, 8)

    copyLinkButton.MouseButton1Click:Connect(function()
        setclipboard(url)
        copyLinkButton.Text = "‚úÖ"
        copyLinkButton.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        task.wait(0.7)
        copyLinkButton.Text = "üõíüîó"
        copyLinkButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    end)

    local playBtn = Instance.new("TextButton")
    playBtn.Size = UDim2.new(0.45, -scale("X", 5), 0, scale("Y", 24))
    playBtn.Position = UDim2.new(0, scale("X", 5), 1, -scale("Y", 29))
    playBtn.BackgroundColor3 = Color3.fromRGB(60, 180, 60)
    playBtn.Text = "Play"
    playBtn.Font = Enum.Font.GothamBold
    playBtn.TextScaled = true
    playBtn.TextColor3 = Color3.new(1, 1, 1)
    playBtn.Parent = card
    createCorner(playBtn, 6)
    playBtn.MouseButton1Click:Connect(function()
        LoadTrack(thumbId)
    end)
    
    local saveBtn = Instance.new("TextButton")
    saveBtn.Size = UDim2.new(0.45, -scale("X", 5), 0, scale("Y", 24))
    saveBtn.Position = UDim2.new(0.55, 0, 1, -scale("Y", 29))
    saveBtn.BackgroundColor3 = Color3.fromRGB(60, 120, 180)
    saveBtn.Text = "Save"
    saveBtn.Font = Enum.Font.GothamBold
    saveBtn.TextScaled = true
    saveBtn.TextColor3 = Color3.new(1, 1, 1)
    saveBtn.Parent = card
    createCorner(saveBtn, 6)
    
    -- Ê∑ªÂä†‰øùÂ≠òÂà∞Âä®ÁîªÂåÖÊåâÈíÆ
    local saveToPackBtn = Instance.new("TextButton")
    saveToPackBtn.Size = UDim2.new(0.45, -scale("X", 5), 0, scale("Y", 24))
    saveToPackBtn.Position = UDim2.new(0.55, 0, 1, -scale("Y", 58))
    saveToPackBtn.BackgroundColor3 = Color3.fromRGB(120, 60, 180)
    saveToPackBtn.Text = "Save to Pack"
    saveToPackBtn.Font = Enum.Font.GothamBold
    saveToPackBtn.TextScaled = true
    saveToPackBtn.TextColor3 = Color3.new(1, 1, 1)
    saveToPackBtn.Parent = card
    createCorner(saveToPackBtn, 6)
    
    saveToPackBtn.MouseButton1Click:Connect(function()
        showSaveToPackDialog(item, thumbId)
    end)
    
    saveBtn.MouseButton1Click:Connect(function()
        local alreadySaved = false
        for _, saved in ipairs(savedEmotes) do
            if saved.Id == item.Id then
                alreadySaved = true
                break
            end
        end
        if not alreadySaved then
            function GetReal(id)
                local ok, obj = pcall(function()
                    return game:GetObjects("rbxassetid://"..tostring(id))
                end)
                if not ok or not obj or #obj == 0 then return end

                local target = obj[1]
                if target:IsA("Animation") and target.AnimationId ~= "" then
                    return tonumber(target.AnimationId:match("%d+"))
                elseif target:FindFirstChildOfClass("Animation") then
                    local anim = target:FindFirstChildOfClass("Animation")
                    return tonumber(anim.AnimationId:match("%d+"))
                end
            end
            table.insert(savedEmotes, {
                Id = item.Id,
                AssetId = thumbId,
                Name = item.Name or "Unknown",
                AnimationId = "rbxassetid://" .. GetReal(thumbId),
                Favorite = false
            })
            saveEmotesToData()
            saveBtn.Text = "Saved!"
            saveBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
            task.wait(1)
            saveBtn.Text = "Save"
            saveBtn.BackgroundColor3 = Color3.fromRGB(60, 120, 180)
        else
            saveBtn.Text = "Already"
            task.wait(0.7)
            saveBtn.Text = "Save"
        end
    end)
    return card
end

local function showSaveToPackDialog(item, thumbId)
    local dialog = Instance.new("Frame")
    dialog.Size = UDim2.new(0, scale("X", 300), 0, scale("Y", 200))
    dialog.Position = UDim2.new(0.5, -scale("X", 150), 0.5, -scale("Y", 100))
    dialog.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    dialog.ZIndex = 20
    dialog.Parent = gui
    createCorner(dialog, 12)
    
    dialog.Active = true
    dialog.Draggable = true
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, scale("Y", 40))
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    title.Text = "Save to Animation Pack"
    title.TextColor3 = Color3.new(1, 1, 1)
    title.Font = Enum.Font.GothamBold
    title.TextScaled = true
    title.ZIndex = 21
    title.Parent = dialog
    createCorner(title, 8)
    
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, scale("X", 30), 0, scale("Y", 30))
    closeBtn.Position = UDim2.new(1, -scale("X", 35), 0, scale("Y", 5))
    closeBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextScaled = true
    closeBtn.ZIndex = 21
    closeBtn.Parent = dialog
    createCorner(closeBtn, 15)
    
    local packName = Instance.new("TextBox")
    packName.Size = UDim2.new(0.8, 0, 0, scale("Y", 30))
    packName.Position = UDim2.new(0.1, 0, 0, scale("Y", 50))
    packName.PlaceholderText = "Pack Name"
    packName.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    packName.TextColor3 = Color3.new(1, 1, 1)
    packName.Font = Enum.Font.Gotham
    packName.TextScaled = true
    packName.ZIndex = 21
    packName.Parent = dialog
    createCorner(packName, 6)
    
    local existingPacksLabel = Instance.new("TextLabel")
    existingPacksLabel.Size = UDim2.new(1, 0, 0, scale("Y", 20))
    existingPacksLabel.Position = UDim2.new(0, 0, 0, scale("Y", 90))
    existingPacksLabel.BackgroundTransparency = 1
    existingPacksLabel.Text = "Or select existing pack:"
    existingPacksLabel.TextColor3 = Color3.new(1, 1, 1)
    existingPacksLabel.Font = Enum.Font.Gotham
    existingPacksLabel.TextScaled = true
    existingPacksLabel.ZIndex = 21
    existingPacksLabel.Parent = dialog
    
    local packsScroll = Instance.new("ScrollingFrame")
    packsScroll.Size = UDim2.new(0.9, 0, 0, scale("Y", 60))
    packsScroll.Position = UDim2.new(0.05, 0, 0, scale("Y", 115))
    packsScroll.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    packsScroll.ScrollBarThickness = 6
    packsScroll.ZIndex = 21
    packsScroll.Parent = dialog
    createCorner(packsScroll, 6)
    
    local packsLayout = Instance.new("UIListLayout")
    packsLayout.Padding = UDim.new(0, 5)
    packsLayout.Parent = packsScroll
    
    local function refreshPacksList()
        for _, child in ipairs(packsScroll:GetChildren()) do
            if child:IsA("Frame") then
                child:Destroy()
            end
        end
        
        for i, pack in ipairs(animationPacks) do
            local packBtn = Instance.new("TextButton")
            packBtn.Size = UDim2.new(1, 0, 0, scale("Y", 25))
            packBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
            packBtn.Text = pack.Name
            packBtn.TextColor3 = Color3.new(1, 1, 1)
            packBtn.Font = Enum.Font.Gotham
            packBtn.TextScaled = true
            packBtn.ZIndex = 22
            packBtn.Parent = packsScroll
            createCorner(packBtn, 4)
            
            packBtn.MouseButton1Click:Connect(function()
                local alreadyInPack = false
                for _, emote in ipairs(pack.Emotes) do
                    if emote.Id == item.Id then
                        alreadyInPack = true
                        break
                    end
                end
                
                if not alreadyInPack then
                    function GetReal(id)
                        local ok, obj = pcall(function()
                            return game:GetObjects("rbxassetid://"..tostring(id))
                        end)
                        if not ok or not obj or #obj == 0 then return end
                        local target = obj[1]
                        if target:IsA("Animation") and target.AnimationId ~= "" then
                            return tonumber(target.AnimationId:match("%d+"))
                        elseif target:FindFirstChildOfClass("Animation") then
                            local anim = target:FindFirstChildOfClass("Animation")
                            return tonumber(anim.AnimationId:match("%d+"))
                        end
                    end
                    
                    table.insert(pack.Emotes, {
                        Id = item.Id,
                        AssetId = thumbId,
                        Name = item.Name or "Unknown",
                        AnimationId = "rbxassetid://" .. GetReal(thumbId)
                    })
                    saveAnimationPacksToData()
                    packBtn.Text = "Added!"
                    packBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
                    task.wait(1)
                    dialog:Destroy()
                else
                    packBtn.Text = "Already in pack"
                    task.wait(0.7)
                    packBtn.Text = pack.Name
                end
            end)
        end
        
        packsScroll.CanvasSize = UDim2.new(0, 0, 0, #animationPacks * 30)
    end
    
    local saveBtn = Instance.new("TextButton")
    saveBtn.Size = UDim2.new(0.4, 0, 0, scale("Y", 30))
    saveBtn.Position = UDim2.new(0.3, 0, 1, -scale("Y", 40))
    saveBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 50)
    saveBtn.Text = "Create New Pack"
    saveBtn.TextColor3 = Color3.new(1, 1, 1)
    saveBtn.Font = Enum.Font.GothamBold
    saveBtn.TextScaled = true
    saveBtn.ZIndex = 21
    saveBtn.Parent = dialog
    createCorner(saveBtn, 6)
    
    saveBtn.MouseButton1Click:Connect(function()
        local packNameText = packName.Text:gsub("%s+", " ")
        if packNameText == "" or packNameText == "Pack Name" then
            packName.Text = "Enter a name!"
            task.wait(0.7)
            packName.Text = "Pack Name"
            return
        end
        
        function GetReal(id)
            local ok, obj = pcall(function()
                return game:GetObjects("rbxassetid://"..tostring(id))
            end)
            if not ok or not obj or #obj == 0 then return end
            local target = obj[1]
            if target:IsA("Animation") and target.AnimationId ~= "" then
                return tonumber(target.AnimationId:match("%d+"))
            elseif target:FindFirstChildOfClass("Animation") then
                local anim = target:FindFirstChildOfClass("Animation")
                return tonumber(anim.AnimationId:match("%d+"))
            end
        end
        
        local newPack = {
            Name = packNameText,
            Id = #animationPacks + 1,
            Emotes = {{
                Id = item.Id,
                AssetId = thumbId,
                Name = item.Name or "Unknown",
                AnimationId = "rbxassetid://" .. GetReal(thumbId)
            }},
            Favorite = false
        }
        
        table.insert(animationPacks, newPack)
        saveAnimationPacksToData()
        saveBtn.Text = "Created!"
        saveBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        task.wait(1)
        dialog:Destroy()
    end)
    
    closeBtn.MouseButton1Click:Connect(function()
        dialog:Destroy()
    end)
    
    refreshPacksList()
end

local scroll = Instance.new("ScrollingFrame")
scroll.Size = UDim2.new(1, -scale("X", 16), 1, -scale("Y", 100))
scroll.Position = UDim2.new(0, scale("X", 8), 0, scale("Y", 36))
scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
scroll.ScrollBarThickness = 6
scroll.BackgroundTransparency = 1
scroll.Parent = catalogFrame

local layout = Instance.new("UIGridLayout", scroll)
layout.CellSize = UDim2.new(0, scale("X", 120), 0, scale("Y", 180))
layout.CellPadding = UDim2.new(0, scale("X", 8), 0, scale("Y", 8))

local emptyLabel = Instance.new("TextLabel", scroll)
emptyLabel.Size = UDim2.new(1, 0, 0, scale("Y", 36))
emptyLabel.Position = UDim2.new(0, 0, 0.5, -scale("Y", 18))
emptyLabel.BackgroundTransparency = 1
emptyLabel.Text = "Nothing Silly Here :3 (except me)"
emptyLabel.TextColor3 = Color3.new(1, 1, 1)
emptyLabel.Font = Enum.Font.GothamBold
emptyLabel.TextScaled = true
emptyLabel.Visible = false

local prevBtn = Instance.new("TextButton", catalogFrame)
prevBtn.Size = UDim2.new(0.4, -scale("X", 6), 0, scale("Y", 32))
prevBtn.Position = UDim2.new(0, scale("X", 4), 1, -scale("Y", 36))
prevBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
prevBtn.Text = "< Prev"
prevBtn.Font = Enum.Font.GothamBold
prevBtn.TextScaled = true
prevBtn.TextColor3 = Color3.new(1, 1, 1)
createCorner(prevBtn, 6)

local nextBtn = Instance.new("TextButton", catalogFrame)
nextBtn.Size = UDim2.new(0.4, -scale("X", 6), 0, scale("Y", 32))
nextBtn.Position = UDim2.new(0.6, scale("X", 2), 1, -scale("Y", 36))
nextBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
nextBtn.Text = "Next >"
nextBtn.Font = Enum.Font.GothamBold
nextBtn.TextScaled = true
nextBtn.TextColor3 = Color3.new(1, 1, 1)
createCorner(nextBtn, 6)

local pageBox = Instance.new("TextBox", catalogFrame)
pageBox.Size = UDim2.new(0.2, 0, 0, scale("Y", 32))
pageBox.Position = UDim2.new(0.4, scale("X", 2), 1, -scale("Y", 36))
pageBox.BackgroundTransparency = 1
pageBox.Font = Enum.Font.Gotham
pageBox.TextScaled = true
pageBox.TextColor3 = Color3.new(1, 1, 1)
pageBox.Text = "1 / Enter page"

local pageNotif = Instance.new("TextLabel", catalogFrame)
pageNotif.Size = UDim2.new(0.3, 0, 0, scale("Y", 24))
pageNotif.Position = UDim2.new(0.35, 0, 1, -scale("Y", 68))
pageNotif.BackgroundTransparency = 1
pageNotif.TextColor3 = Color3.fromRGB(255, 120, 80)
pageNotif.Font = Enum.Font.Gotham
pageNotif.TextScaled = true
pageNotif.Text = ""
pageNotif.Visible = false

local function updateNavVisibility()
    prevBtn.Visible = (currentPageNumber > 1)
    if currentPages and typeof(currentPages.IsFinished) == "boolean" then
        nextBtn.Visible = not currentPages.IsFinished
    else
        nextBtn.Visible = true
    end
end

local RunService = game:GetService("RunService")
local isLoading = false

local function showPage(pages)
    if isLoading then return end
    isLoading = true

    pageBox.Text = "Loading..."
    RunService.RenderStepped:Wait() -- let UI update

    for _, child in ipairs(scroll:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end

    local currentList = nil
    local ok, got = pcall(function()
        return pages:GetCurrentPage()
    end)

    if ok then
        currentList = got
    else
        pageBox.Text = "ERROR"
        isLoading = false
        return
    end

    if currentList and #currentList > 0 then
        emptyLabel.Visible = false
        for _, item in ipairs(currentList) do
            createCard(item).Parent = scroll
            RunService.RenderStepped:Wait() -- optional: spread creation over frames
        end
    else
        emptyLabel.Visible = true
    end

    scroll.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 8)
    pageBox.Text = tostring(currentPageNumber) .. " / Enter page"
    updateNavVisibility()

    isLoading = false
end

local function fetchPagesTo(targetPage)
    local pages = getPages(currentKeyword)
    if not pages then return nil end
    for i = 2, targetPage do
        if pages.IsFinished then break end
        local ok, err = pcall(function()
            pages:AdvanceToNextPageAsync()
        end)
        if not ok then break end
    end
    return pages
end

local function doNewSearch(keyword)
    currentKeyword = keyword or ""
    currentPageNumber = 1
    pageBox.Text = "Loading..."
    
    currentPages = getPages(currentKeyword)
    if currentPages then
        showPage(currentPages)
    end
end

refreshBtn.MouseButton1Click:Connect(function()
    doNewSearch(searchBox.Text)
end)

searchBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        doNewSearch(searchBox.Text)
    end
end)

sortBtn.MouseButton1Click:Connect(function()
    currentSortIndex = currentSortIndex % #sortModes + 1
    sortBtn.Text = "Sort: " .. sortModes[currentSortIndex][2]
    doNewSearch(currentKeyword)
end)

local UserInputService = game:GetService("UserInputService")

local function goNextPage()
    if not currentPages or currentPages.IsFinished then return end
    local ok, err = pcall(function()
        currentPages:AdvanceToNextPageAsync()
    end)
    if ok then
        currentPageNumber += 1
        showPage(currentPages)
    else
        local targetPage = currentPageNumber + 1
        local fresh = fetchPagesTo(targetPage)
        if fresh then
            currentPages = fresh
            currentPageNumber = math.min(targetPage, currentPageNumber + 1)
            showPage(currentPages)
        end
    end
end

local function goPrevPage()
    if not currentPages or currentPageNumber <= 1 then return end
    local ok, err = pcall(function()
        currentPages:AdvanceToPreviousPageAsync()
    end)
    if ok then
        currentPageNumber = math.max(1, currentPageNumber - 1)
        showPage(currentPages)
    else
        local targetPage = math.max(1, currentPageNumber - 1)
        local fresh = fetchPagesTo(targetPage)
        if fresh then
            currentPages = fresh
            currentPageNumber = targetPage
            showPage(currentPages)
        end
    end
end

nextBtn.MouseButton1Click:Connect(goNextPage)
prevBtn.MouseButton1Click:Connect(goPrevPage)

UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Right then
        goNextPage()
    elseif input.KeyCode == Enum.KeyCode.Left then
        goPrevPage()
    end
end)

pageBox.FocusLost:Connect(function(enterPressed)
    if not enterPressed then return end
    local text = pageBox.Text:gsub("%s+", "")
    local num = tonumber(text:match("%d+"))
    if not num or num < 1 then
        pageNotif.Text = "Invalid page number"
        pageNotif.Visible = true
        task.delay(2, function()
            if pageNotif then
                pageNotif.Visible = false
            end
        end)
        pageBox.Text = "Page " .. tostring(currentPageNumber)
        return
    end
    local targetPage = math.floor(num)
    if targetPage == currentPageNumber then
        pageBox.Text = "Page " .. tostring(currentPageNumber)
        return
    end
    pageBox.Text = "Loading..."
    local ok, pages = pcall(function()
        return fetchPagesTo(targetPage)
    end)
    if not ok or not pages then
        pageNotif.Text = "Unable to fetch page"
        pageNotif.Visible = true
        task.delay(2, function()
            if pageNotif then
                pageNotif.Visible = false
            end
        end)
        pageBox.Text = "Page " .. tostring(currentPageNumber)
        return
    end
    currentPages = pages
    currentPageNumber = math.max(1, targetPage)
    showPage(currentPages)
end)

catalogTabBtn.MouseButton1Click:Connect(function()
    catalogFrame.Visible = true
    savedFrame.Visible = false
    animationPacksFrame.Visible = false
    catalogTabBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 120)
    savedTabBtn.BackgroundColor3 = Color3.fromRGB(40, 80, 40)
    animationPacksTabBtn.BackgroundColor3 = Color3.fromRGB(80, 40, 120)
end)

local function createSavedCard(item)
    local card = Instance.new("Frame")
    card.Size = UDim2.new(0, scale("X", 120), 0, scale("Y", 200))
    card.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
    createCorner(card, 8)
    local img = Instance.new("ImageLabel")
    img.Size = UDim2.new(1, -scale("X", 10), 0, scale("Y", 90))
    img.Position = UDim2.new(0, scale("X", 5), 0, scale("Y", 5))
    img.BackgroundTransparency = 1
    img.ScaleType = Enum.ScaleType.Fit
    pcall(function()
        img.Image = "rbxthumb://type=Asset&id=11768914234&w=150&h=150"
    end)
    img.Parent = card
    createCorner(img, 6)
    local name = Instance.new("TextLabel")
    name.Size = UDim2.new(1, -scale("X", 10), 0, scale("Y", 28))
    name.Position = UDim2.new(0, scale("X", 5), 0, scale("Y", 100))
    name.BackgroundTransparency = 1
    name.Text = item.Name or "Unknown"
    name.TextScaled = true
    name.TextWrapped = true
    name.Font = Enum.Font.GothamBold
    name.TextColor3 = Color3.new(1, 1, 1)
    name.Parent = card
    local playBtn = Instance.new("TextButton")
    playBtn.Size = UDim2.new(0.45, -scale("X", 5), 0, scale("Y", 24))
    playBtn.Position = UDim2.new(0, scale("X", 5), 1, -scale("Y", 29))
    playBtn.BackgroundColor3 = Color3.fromRGB(60, 180, 60)
    playBtn.Text = "Play"
    playBtn.Font = Enum.Font.GothamBold
    playBtn.TextScaled = true
    playBtn.TextColor3 = Color3.new(1, 1, 1)
    playBtn.Parent = card
    createCorner(playBtn, 6)
    playBtn.MouseButton1Click:Connect(function()
        LoadTrack(item.Id)
    end)
    local removeBtn = Instance.new("TextButton")
    removeBtn.Size = UDim2.new(0.45, -scale("X", 5), 0, scale("Y", 24))
    removeBtn.Position = UDim2.new(0.55, 0, 1, -scale("Y", 29))
    removeBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
    removeBtn.Text = "Remove"
    removeBtn.Font = Enum.Font.GothamBold
    removeBtn.TextScaled = true
    removeBtn.TextColor3 = Color3.new(1, 1, 1)
    removeBtn.Parent = card
    createCorner(removeBtn, 6)
    
    local copyBtn = Instance.new("TextButton")
    copyBtn.Size = UDim2.new(0, scale("X", 40), 0, scale("Y", 24))
    copyBtn.Position = UDim2.new(0.5, -scale("X", 20), 0, scale("Y", 5))
    copyBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 150)
    copyBtn.Text = "Copy AnimId"
    copyBtn.Font = Enum.Font.GothamBold
    copyBtn.TextScaled = true
    copyBtn.TextColor3 = Color3.new(1, 1, 1)
    copyBtn.Parent = card
    createCorner(copyBtn, 6)

    copyBtn.MouseButton1Click:Connect(function()
        if setclipboard then
            setclipboard(item.AnimationId:gsub("rbxassetid://", ""))
        end
        copyBtn.Text = "Copied!"
        task.wait(0.7)
        copyBtn.Text = "Copy AnimId"
    end)
    
    local favBtn = Instance.new("TextButton")
    favBtn.Size = UDim2.new(0, scale("X", 24), 0, scale("Y", 24))
    favBtn.Position = UDim2.new(1, -scale("X", 30), 0, scale("Y", 5))
    favBtn.Text = item.Favorite and "‚òÖ" or "‚òÜ"
    favBtn.Font = Enum.Font.GothamBold
    favBtn.TextScaled = true
    favBtn.TextColor3 = Color3.fromRGB(255, 255, 0)
    favBtn.BackgroundTransparency = 1
    favBtn.Parent = card
    favBtn.MouseButton1Click:Connect(function()
        item.Favorite = not item.Favorite
        favBtn.Text = item.Favorite and "‚òÖ" or "‚òÜ"
        saveEmotesToData()
    end)
    removeBtn.MouseButton1Click:Connect(function()
        for i, saved in ipairs(savedEmotes) do
            if saved.Id == item.Id then
                table.remove(savedEmotes, i)
                saveEmotesToData()
                refreshSavedTab()
                break
            end
        end
    end)
    return card
end

function refreshSavedTab()
    for _, child in ipairs(savedScroll:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end
    local text = (savedSearch.Text or ""):lower()
    local results = {}
    for _, item in ipairs(savedEmotes) do
        if text == "" or (item.Name and item.Name:lower():find(text)) then
            table.insert(results, item)
        end
    end
    table.sort(results, function(a, b)
        if a.Favorite ~= b.Favorite then
            return a.Favorite
        else
            return false
        end
    end)
    if #results > 0 then
        savedEmptyLabel.Visible = false
        for _, item in ipairs(results) do
            createSavedCard(item).Parent = savedScroll
        end
    else
        savedEmptyLabel.Visible = true
    end
    savedScroll.CanvasSize = UDim2.new(0, 0, 0, savedLayout.AbsoluteContentSize.Y + 8)
end

savedSearch:GetPropertyChangedSignal("Text"):Connect(refreshSavedTab)

savedTabBtn.MouseButton1Click:Connect(function()
    catalogFrame.Visible = false
    savedFrame.Visible = true
    animationPacksFrame.Visible = false
    catalogTabBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 80)
    savedTabBtn.BackgroundColor3 = Color3.fromRGB(60, 120, 60)
    animationPacksTabBtn.BackgroundColor3 = Color3.fromRGB(80, 40, 120)
    refreshSavedTab()
end)

animationPacksTabBtn.MouseButton1Click:Connect(function()
    catalogFrame.Visible = false
    savedFrame.Visible = false
    animationPacksFrame.Visible = true
    catalogTabBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 80)
    savedTabBtn.BackgroundColor3 = Color3.fromRGB(40, 80, 40)
    animationPacksTabBtn.BackgroundColor3 = Color3.fromRGB(120, 60, 180)
    refreshAnimationPacksTab()
end)

local function doNewSearchInitial()
    doNewSearch("")
end

doNewSearchInitial()

local targetGui = gui

local function toggleGui()
    targetGui.Enabled = not targetGui.Enabled
end

local screonGui = Instance.new("ScreenGui")
screonGui.Name = "ToggleButtonGui"
screonGui.ResetOnSpawn = false
screonGui.Parent = CoreGui
screonGui.Enabled = true
local btn = Instance.new("TextButton")
btn.Parent = screonGui
btn.Text = "G"
btn.Font = Enum.Font.GothamSemibold
btn.TextScaled = true
btn.Size = UDim2.new(0, 50, 0, 50)
btn.Position = UDim2.new(0, 20, 0.5, -50)
btn.AnchorPoint = Vector2.new(0, 0.5)
btn.Active = true
pcall(function() btn.Draggable = true end)
local aspect = Instance.new("UIAspectRatioConstraint")
aspect.Parent = btn
aspect.AspectRatio = 1
local corner = Instance.new("UICorner")
corner.Parent = btn
corner.CornerRadius = UDim.new(0, 12)
btn.MouseButton1Click:Connect(toggleGui)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.G then
        toggleGui()
    end
end)

gui.Enabled = true
refreshSavedTab()

-- ÂàùÂßãÂåñÂä®ÁîªÂåÖÊ†áÁ≠æÈ°µ
local function refreshAnimationPacksTab()
    for _, child in ipairs(animationPacksScroll:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end
    
    local text = (animationPacksSearch.Text or ""):lower()
    local results = {}
    
    for _, pack in ipairs(animationPacks) do
        if text == "" or (pack.Name and pack.Name:lower():find(text)) then
            table.insert(results, pack)
        end
    end
    
    if #results > 0 then
        animationPacksEmptyLabel.Visible = false
        for _, pack in ipairs(results) do
            local card = Instance.new("Frame")
            card.Size = UDim2.new(0, scale("X", 140), 0, scale("Y", 180))
            card.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
            createCorner(card, 8)
            card.Parent = animationPacksScroll
            
            local nameLabel = Instance.new("TextLabel")
            nameLabel.Size = UDim2.new(1, -scale("X", 10), 0, scale("Y", 40))
            nameLabel.Position = UDim2.new(0, scale("X", 5), 0, scale("Y", 5))
            nameLabel.BackgroundTransparency = 1
            nameLabel.Text = pack.Name or "Unnamed Pack"
            nameLabel.TextColor3 = Color3.new(1, 1, 1)
            nameLabel.Font = Enum.Font.GothamBold
            nameLabel.TextScaled = true
            nameLabel.TextWrapped = true
            nameLabel.Parent = card
            
            local countLabel = Instance.new("TextLabel")
            countLabel.Size = UDim2.new(1, -scale("X", 10), 0, scale("Y", 20))
            countLabel.Position = UDim2.new(0, scale("X", 5), 0, scale("Y", 50))
            countLabel.BackgroundTransparency = 1
            countLabel.Text = "Contains " .. tostring(#pack.Emotes) .. " emotes"
            countLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
            countLabel.Font = Enum.Font.Gotham
            countLabel.TextScaled = true
            countLabel.Parent = card
            
            local viewBtn = Instance.new("TextButton")
            viewBtn.Size = UDim2.new(0.9, 0, 0, scale("Y", 24))
            viewBtn.Position = UDim2.new(0.05, 0, 1, -scale("Y", 55))
            viewBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
            viewBtn.Text = "View"
            viewBtn.TextColor3 = Color3.new(1, 1, 1)
            viewBtn.Font = Enum.Font.GothamBold
            viewBtn.TextScaled = true
            viewBtn.Parent = card
            createCorner(viewBtn, 6)
            
            local deleteBtn = Instance.new("TextButton")
            deleteBtn.Size = UDim2.new(0.9, 0, 0, scale("Y", 24))
            deleteBtn.Position = UDim2.new(0.05, 0, 1, -scale("Y", 25))
            deleteBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
            deleteBtn.Text = "Delete"
            deleteBtn.TextColor3 = Color3.new(1, 1, 1)
            deleteBtn.Font = Enum.Font.GothamBold
            deleteBtn.TextScaled = true
            deleteBtn.Parent = card
            createCorner(deleteBtn, 6)
            
            viewBtn.MouseButton1Click:Connect(function()
                showAnimationPackDetails(pack)
            end)
            
            deleteBtn.MouseButton1Click:Connect(function()
                for i, p in ipairs(animationPacks) do
                    if p.Id == pack.Id then
                        table.remove(animationPacks, i)
                        saveAnimationPacksToData()
                        refreshAnimationPacksTab()
                        break
                    end
                end
            end)
        end
    else
        animationPacksEmptyLabel.Visible = true
    end
    
    animationPacksScroll.CanvasSize = UDim2.new(0, 0, 0, animationPacksLayout.AbsoluteContentSize.Y + 10)
end

animationPacksSearch:GetPropertyChangedSignal("Text"):Connect(refreshAnimationPacksTab)

local function showAnimationPackDetails(packData)
    local detailsFrame = Instance.new("Frame")
    detailsFrame.Size = UDim2.new(0, scale("X", 400), 0, scale("Y", 300))
    detailsFrame.Position = UDim2.new(0.5, -scale("X", 200), 0.5, -scale("Y", 150))
    detailsFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    detailsFrame.ZIndex = 10
    detailsFrame.Parent = gui
    createCorner(detailsFrame, 12)
    
    detailsFrame.Active = true
    detailsFrame.Draggable = true
    
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, scale("X", 30), 0, scale("Y", 30))
    closeBtn.Position = UDim2.new(1, -scale("X", 35), 0, scale("Y", 5))
    closeBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextScaled = true
    closeBtn.ZIndex = 11
    closeBtn.Parent = detailsFrame
    createCorner(closeBtn, 15)
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -scale("X", 40), 0, scale("Y", 40))
    titleLabel.Position = UDim2.new(0, scale("X", 10), 0, scale("Y", 10))
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = packData.Name
    titleLabel.TextColor3 = Color3.new(1, 1, 1)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextScaled = true
    titleLabel.ZIndex = 11
    titleLabel.Parent = detailsFrame
    
    local scroll = Instance.new("ScrollingFrame")
    scroll.Size = UDim2.new(1, -scale("X", 20), 1, -scale("Y", 60))
    scroll.Position = UDim2.new(0, scale("X", 10), 0, scale("Y", 60))
    scroll.BackgroundTransparency = 1
    scroll.ScrollBarThickness = 6
    scroll.ZIndex = 11
    scroll.Parent = detailsFrame
    
    local layout = Instance.new("UIListLayout")
    layout.Padding = UDim.new(0, 5)
    layout.Parent = scroll
    
    for _, emote in ipairs(packData.Emotes) do
        local emoteFrame = Instance.new("Frame")
        emoteFrame.Size = UDim2.new(1, 0, 0, scale("Y", 40))
        emoteFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        emoteFrame.ZIndex = 12
        emoteFrame.Parent = scroll
        createCorner(emoteFrame, 6)
        
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Size = UDim2.new(0.6, 0, 1, 0)
        nameLabel.Position = UDim2.new(0, scale("X", 10), 0, 0)
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = emote.Name or "Unknown Emote"
        nameLabel.TextColor3 = Color3.new(1, 1, 1)
        nameLabel.Font = Enum.Font.Gotham
        nameLabel.TextScaled = true
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.ZIndex = 13
        nameLabel.Parent = emoteFrame
        
        local playBtn = Instance.new("TextButton")
        playBtn.Size = UDim2.new(0.2, 0, 0.7, 0)
        playBtn.Position = UDim2.new(0.6, scale("X", 5), 0.15, 0)
        playBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 50)
        playBtn.Text = "Play"
        playBtn.TextColor3 = Color3.new(1, 1, 1)
        playBtn.Font = Enum.Font.GothamBold
        playBtn.TextScaled = true
        playBtn.ZIndex = 13
        playBtn.Parent = emoteFrame
        createCorner(playBtn, 6)
        
        local removeBtn = Instance.new("TextButton")
        removeBtn.Size = UDim2.new(0.2, 0, 0.7, 0)
        removeBtn.Position = UDim2.new(0.8, scale("X", 5), 0.15, 0)
        removeBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
        removeBtn.Text = "Remove"
        removeBtn.TextColor3 = Color3.new(1, 1, 1)
        removeBtn.Font = Enum.Font.GothamBold
        removeBtn.TextScaled = true
        removeBtn.ZIndex = 13
        removeBtn.Parent = emoteFrame
        createCorner(removeBtn, 6)
        
        playBtn.MouseButton1Click:Connect(function()
            LoadTrack(emote.Id)
        end)
        
        removeBtn.MouseButton1Click:Connect(function()
            for i, e in ipairs(packData.Emotes) do
                if e.Id == emote.Id then
                    table.remove(packData.Emotes, i)
                    saveAnimationPacksToData()
                    showAnimationPackDetails(packData)
                    break
                end
            end
        end)
    end
    
    scroll.CanvasSize = UDim2.new(0, 0, 0, #packData.Emotes * 45)
    
    closeBtn.MouseButton1Click:Connect(function()
        detailsFrame:Destroy()
    end)
end

-- ËÑöÊú¨ÁªìÊùü
print("Gaze Emotes loaded successfully!")
print("Press G to toggle the GUI")
print("Features: Catalog search, Saved emotes, Animation packs, Settings")
